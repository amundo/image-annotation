<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Patrick Hall" />
  <title>Building an image annotation Web Component</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Building an image annotation Web Component</h1>
<p class="author">Patrick Hall</p>
</header>
<h2 id="introduction">Introduction</h2>
<p>I have found many contexts in which it would be useful to add
annotations to images. For example, I am interested in writing systems
for various reasons, and I often need to add annotations to images of
text. I am also interested in building Web Components, and I thought it
would be fun to build a Web Component that allows users to add
annotations to images. This post describes the workflow I used to build
the Web Component and the Web Component itself.</p>
<h2 id="the-workflow">The workflow</h2>
<p>The workflow I have in mind for users is as follows:</p>
<ol type="1">
<li>The user selects an image to annotate.</li>
<li>The user selects a tool to use for annotation.</li>
<li>The user uses the tool to annotate the image.</li>
<li>The user saves the annotations.</li>
</ol>
<h2 id="challenges">Challenges</h2>
<p>Probably the most difficult part of this project (in my estimation,
after having made various prototypes) is managing issues to do with
image scaling. Typically, annotating an image isn’t worth the effort
with a low-resolution image of small dimensions. But with a large image,
the user will need to zoom in and out to annotate different parts of the
image. This means that selections for annotations will also have to
scale. I have started looking into this spacing using
<code>&lt;canvas&gt;</code>, but the problem with that is that
selections are just pixels, and so they don’t scale with the image. I
think a better solution is to use <code>&lt;svg&gt;</code>, so that the
selections are <code>&lt;rect&gt;</code> elements. (Additionally, in the
future it would be possible to support polygons. <a
href="https://geojson.io" class="uri">https://geojson.io</a> is an
inspiration for me here.)</p>
<h2 id="the-web-component">The Web Component</h2>
<p>The basic user interface I have in mind looks like this:</p>
<p><a href="basic-interface.html">basic-interface.html</a></p>
<iframe src="basic-interface.html" width="100%" height="300px">
</iframe>
<p>Fugly, I know. The point right now is just to figure out what
elements are necessary. To be honest I could probably dispense with the
toolbar, but one must dream.</p>
<h3 id="bearable-styling">Bearable styling</h3>
<p>Because god.</p>
<p>Until we get to building out the component, I’ll keep working
directly in the <code>&lt;body&gt;</code> tag as the top level.</p>
<p><a href="bearable-styling.html">bearable-styling.html</a></p>
<iframe src="bearable-styling.html" width="100%" height="300px">
</iframe>
<p>Building things always makes you realize what’s obvious: we’re
missing some kind of pane to see and edit annotations. But we don’t have
any yet anyway, so we’ll come back to this. Let’s start with task one:
loading an image.</p>
<h3 id="loading-an-image">Loading an image</h3>
<p>The basic idea here is: when the user selects an image, add it to the
<code>&lt;svg&gt;</code>.</p>
<p>We’re going to want the image to be <em>in</em> the
<code>&lt;svg&gt;</code> as opposed to a background image or something,
because we’re going to need to zoom things. That means using the
<code>&lt;image&gt;</code> tag.</p>
<p>So try loading <a href="mereri.jpg">mereri.jpg</a> using the
interface below:</p>
<p><a href="load-image.html">load-image.html</a></p>
<iframe src="load-image.html" width="100%" height="300px">
</iframe>
<p>This doesn’t do much, it just alerts the file name when we load it.
But at least we know loading is happening.</p>
<p>Now, we need to actually load the image into the
<code>&lt;svg&gt;</code>. Our strategy will be to insert the file object
into the DOM at the <code>href</code> of the <code>&lt;image&gt;</code>
element. This isn’t <em>too</em> bad. The <code>.files</code> property
of the <code>&lt;input type=files&gt;</code> is a <a
href="https://developer.mozilla.org/en-US/docs/Web/API/File">File
object</a>, which means that is a subtype of a <code>Blob</code>. And a
blob, in case you are unfamiliar, is just some undifferentiated data
stored by the browser and given an URL. So we don’t even need to use
anything like <code>URL.createObjectURL()</code>, because the file
already <em>has</em> a URL. In fact, if we pass a reference to our file
object when we are creating the <code>&lt;image&gt;</code> tag’s
<code>HTML</code>, the browser will put a blob URL in place and it will
work.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">let</span> loadImage <span class="op">=</span> <span class="kw">async</span> changeEvent <span class="kw">=&gt;</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> image <span class="op">=</span> changeEvent<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> request <span class="op">=</span> <span class="kw">new</span> <span class="fu">Response</span>(image)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> blob <span class="op">=</span> <span class="cf">await</span> request<span class="op">.</span><span class="fu">blob</span>()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> imageHTML <span class="op">=</span> <span class="vs">`&lt;image id=svg-image x=&quot;0&quot; y=&quot;0&quot; /&gt;`</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;svg&#39;</span>)<span class="op">.</span><span class="fu">insertAdjacentHTML</span>(<span class="st">&#39;beforeend&#39;</span><span class="op">,</span> imageHTML)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#svg-image&#39;</span>)<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;href&#39;</span><span class="op">,</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input[type=file]&#39;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> changeEvent <span class="kw">=&gt;</span> <span class="fu">loadImage</span>(changeEvent))</span></code></pre></div>
<p><a href="load-image-2.html">load-image-2.html</a></p>
<iframe src="load-image-2.html" width="100%" height="300px">
</iframe>
<p>As you can see, we have a problem. By way of explanation, here’s the
sample image we’re using (I’ve put an explicit <code>width</code> on it
here, it’s actually <a href="mereri.jpg">bigger</a>):</p>
<p><img src=mereri.jpg width=500></p>
<p>But this is not a  “data” problem — the image has been loaded
correctly. As you can see below, the <code>href</code> attribute of the
<code>&lt;image&gt;</code> tag is set to contain a blob URL:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">image</span><span class="ot"> id=</span><span class="st">&quot;svg-image&quot;</span><span class="ot"> x=</span><span class="st">&quot;0&quot;</span><span class="ot"> y=</span><span class="st">&quot;0&quot;</span><span class="ot"> href=</span><span class="st">&quot;blob:http://localhost:1111/cfe75b6a-887d-4d1a-81bb-c3a65ac28461&quot;</span>&gt;&lt;/<span class="kw">image</span>&gt;</span></code></pre></div>
<h3 id="fitting-the-image-into-the-svg">Fitting the image into the
SVG</h3>
<p>So, how do we make things fit?</p>
<p>The first thing to do is to make sure that the
<code>&lt;svg&gt;</code> is the same size as the image. We can do this
by setting the <code>width</code> and <code>height</code> attributes of
the <code>&lt;svg&gt;</code> to the <code>naturalWidth</code> and
<code>naturalHeight</code> of the image.</p>
<p>```js cd =</p>
<p>Oh boy, the wide world of viewports. This stuff will drive you
bonkers. The best resources I know are:</p>
<ul>
<li><a href="https://www.sarasoueidan.com/blog/svg-coordinate-systems/"
class="uri">https://www.sarasoueidan.com/blog/svg-coordinate-systems/</a></li>
<li><a
href="https://developer.mozilla.org/en-US/docs/Web/CSS/Viewport_concepts"
class="uri">https://developer.mozilla.org/en-US/docs/Web/CSS/Viewport_concepts</a></li>
</ul>
</body>
</html>
