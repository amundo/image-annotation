<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Patrick Hall" />
  <title>Building an image annotation Web Component</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Building an image annotation Web Component</h1>
<p class="author">Patrick Hall</p>
</header>
<style>
  * {
    box-sizing:border-box;
  }

  pre > code.sourceCode {
    white-space: pre-wrap;;
  }

  details {
    border-left: 1px dashed gray;
    padding:1em;
    background-color:#efefef;
    cursor: pointer;
  }
</style>
<h2 id="introduction">Introduction</h2>
<p>I have found many contexts in which it would be useful to add
annotations to images. For example, I am interested in writing systems
for various reasons, and I often need to add annotations to images of
text. I am also interested in building Web Components, and I thought it
would be fun to build a Web Component that allows users to add
annotations to images. In this article I am keeping a record of the
steps I took and research I had to do to get the component working.</p>
<h2 id="the-workflow">The workflow</h2>
<p>The workflow I have in mind for users is as follows:</p>
<ol type="1">
<li>The user selects an image to annotate.</li>
<li>The user selects a tool to use for annotation.</li>
<li>The user uses the tool to annotate the image.</li>
<li>The user saves the annotations.</li>
</ol>
<h2 id="challenges">Challenges</h2>
<p>Probably the most difficult part of this project (in my estimation,
after having made various prototypes) is managing issues to do with
image scaling. Typically, annotating an image isn’t worth the effort
with a low-resolution image of small dimensions. But with a large image,
the user will need to zoom in and out to annotate different parts of the
image. This means that selections for annotations will also have to
scale. I have started looking into this spacing using
<code>&lt;canvas&gt;</code>, but the problem with that is that
selections are just pixels, and so they don’t scale with the image. I
think a better solution is to use <code>&lt;svg&gt;</code>, so that the
selections are <code>&lt;rect&gt;</code> elements. (Additionally, in the
future it would be possible to support polygons. <a
href="https://geojson.io" class="uri">https://geojson.io</a> is an
inspiration for me here.)</p>
<h2 id="the-basic-user-interface">The basic user interface</h2>
<p>The basic user interface I have in mind looks like this:</p>
<p><a href="./basic-interface.html">basic-interface.html</a></p>
<iframe src="basic-interface.html" width="100%" height="300px">
</iframe>
<p>Fugly, I know. The point right now is just to figure out what
elements are necessary. To be honest I could probably dispense with the
toolbar, but one must dream.</p>
<h3 id="bearable-styling">Bearable styling</h3>
<p>Because god.</p>
<p>Until we get to building out the component, I’ll keep working
directly in the <code>&lt;body&gt;</code> tag as the top level.</p>
<p><a href="bearable-styling.html">bearable-styling.html</a></p>
<iframe src="bearable-styling.html" width="100%" height="300px">
</iframe>
<p>Building things always makes you realize what’s obvious: we’re
missing some kind of pane to see and edit annotations. But we don’t have
any yet anyway, so we’ll come back to this. Let’s start with task one:
loading an image.</p>
<h2 id="loading-the-image-into-an-image">Loading the image into an
<code>&lt;image&gt;</code></h2>
<p>The basic idea here is: when the user selects an image, add it to the
<code>&lt;svg&gt;</code>.</p>
<p>We’re going to want the image to be <em>in</em> the
<code>&lt;svg&gt;</code> as opposed to a background image or something,
because we’re going to need to zoom things. That means using the
<code>&lt;image&gt;</code> tag.</p>
<p>We’ll be using a couple images files in this project, they are
included in the repo, so you can load them with the file picker from
wherever you are running your <code>localhost</code>. (They are from the
<a
href="https://www.nms.ac.uk/explore-our-collections/collection-search-results/stela/300280">National
Museum of Scotland</a>). We’ll be using the one called
<code>mereri.jpg</code> for this example.</p>
<p>So try loading <a href="mereri.jpg">mereri.jpg</a> using the
interface below:</p>
<p><a href="load-image.html">load-image.html</a></p>
<iframe src="load-image.html" width="100%" height="300px">
</iframe>
<p>This doesn’t do much, it just alerts the file name when we load it.
But at least we know loading is happening.</p>
<p>Now, we need to actually load the image into the
<code>&lt;svg&gt;</code>. Our strategy will be to insert the file object
into the DOM at the <code>href</code> of the <code>&lt;image&gt;</code>
element. The <code>.files</code> property of the
<code>&lt;input type=files&gt;</code> is a <a
href="https://developer.mozilla.org/en-US/docs/Web/API/File">File
object</a>, which means that is a subtype of a <code>Blob</code>. And a
blob, in case you are unfamiliar, is just some undifferentiated data
stored by the browser and given an URL. So we don’t even need to use
anything like <code>URL.createObjectURL()</code>, because the file
already <em>has</em> a URL. In fact, if we pass a reference to our file
object when we are creating the <code>&lt;image&gt;</code> tag’s
<code>HTML</code>, the browser will put a blob URL in place and it will
work.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">let</span> loadImage <span class="op">=</span> <span class="kw">async</span> changeEvent <span class="kw">=&gt;</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> image <span class="op">=</span> changeEvent<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">files</span>[<span class="dv">0</span>]</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> request <span class="op">=</span> <span class="kw">new</span> <span class="fu">Response</span>(image)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> blob <span class="op">=</span> <span class="cf">await</span> request<span class="op">.</span><span class="fu">blob</span>()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> imageHTML <span class="op">=</span> <span class="vs">`&lt;image id=svg-image x=&quot;0&quot; y=&quot;0&quot; /&gt;`</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;svg&#39;</span>)<span class="op">.</span><span class="fu">insertAdjacentHTML</span>(<span class="st">&#39;beforeend&#39;</span><span class="op">,</span> imageHTML)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;#svg-image&#39;</span>)<span class="op">.</span><span class="fu">setAttribute</span>(<span class="st">&#39;href&#39;</span><span class="op">,</span> URL<span class="op">.</span><span class="fu">createObjectURL</span>(blob))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;input[type=file]&#39;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;change&#39;</span><span class="op">,</span> changeEvent <span class="kw">=&gt;</span> <span class="fu">loadImage</span>(changeEvent))</span></code></pre></div>
<p><a href="load-image-2.html">load-image-2.html</a></p>
<iframe src="load-image-2.html" width="100%" height="300px">
</iframe>
<p>As you can see, we’re back to our original problem: the image doesn’t
fit in the <code>&lt;svg&gt;</code>. But this is not a  “data” problem —
the image has been loaded correctly. As you can see below, the
<code>href</code> attribute of the <code>&lt;image&gt;</code> tag is set
to contain a blob URL (once you have loaded the image):</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">image</span><span class="ot"> id=</span><span class="st">&quot;svg-image&quot;</span><span class="ot"> x=</span><span class="st">&quot;0&quot;</span><span class="ot"> y=</span><span class="st">&quot;0&quot;</span><span class="ot"> href=</span><span class="st">&quot;blob:http://localhost:1111/cfe75b6a-887d-4d1a-81bb-c3a65ac28461&quot;</span>&gt;&lt;/<span class="kw">image</span>&gt;</span></code></pre></div>
<p>Of course, your blob URL’s <a
href="https://en.wikipedia.org/wiki/Universally_unique_identifier">GUID</a>
will be different.</p>
<h2 id="scaling-images">Scaling Images</h2>
<h3 id="scaling-images-in-img-tags">Scaling images in
<code>&lt;img&gt;</code> tags</h3>
<p>Plain old <code>&lt;img&gt;</code> tags have their own rules about
scaling, and they’re pretty simple. They render the entire image,
although you can adjust size and aspect ratio.</p>
<p>By default, if you just stick an image into a page, it’s going to be
full-size.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">mereri.jpg</span>  <span class="er">style</span><span class="ot">=</span><span class="st">max-width:none;border:1px</span> <span class="er">solid&quot;</span> <span class="er">class</span><span class="ot">=</span><span class="st">show-image-size</span><span class="kw">&gt;</span></span></code></pre></div>
<p><img src=mereri.jpg  style="max-width:none;border:1px solid" class=show-image-size></p>
<p>As you can see, this image is 2000px wide and thus probably way too
large for you to see. By default, I use a rule that says
<code>img { max-width: 100%}</code>, so that images are never bigger
than their parent container and thus always fit on the page. For the
example above I turned off that default.</p>
<details>
<summary>
Where the size data comes from
</summary>
<p>I used a little code to generate the dimension sizes of any image in
this page with a class of <code>.show-image-size</code>. It looks like
this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.show-image-size&#39;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">forEach</span>(img <span class="kw">=&gt;</span> {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    img<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;load&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> p <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;p&#39;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> {width<span class="op">,</span> height } <span class="op">=</span> img<span class="op">.</span><span class="fu">getBoundingClientRect</span>()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> {naturalWidth<span class="op">,</span> naturalHeight} <span class="op">=</span> img</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      p<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`&lt;table&gt;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tr&gt;&lt;th&gt;naturalWidth&lt;/th&gt;&lt;td&gt;</span><span class="sc">${</span><span class="pp">parseInt</span>(naturalWidth)<span class="sc">}</span><span class="vs">px&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tr&gt;&lt;th&gt;naturalHeight&lt;/th&gt;&lt;td&gt;</span><span class="sc">${</span><span class="pp">parseInt</span>(naturalHeight)<span class="sc">}</span><span class="vs">px&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tr&gt;&lt;th&gt;rendered width&lt;/th&gt;&lt;td&gt;</span><span class="sc">${</span><span class="pp">parseInt</span>(width)<span class="sc">}</span><span class="vs">px&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;tr&gt;&lt;th&gt;rendered height&lt;/th&gt;&lt;td&gt;</span><span class="sc">${</span><span class="pp">parseInt</span>(height)<span class="sc">}</span><span class="vs">px&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="vs">      &lt;/table&gt;`</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>      img<span class="op">.</span><span class="fu">after</span>(p)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  })</span></code></pre></div>
The <code>naturalWidth</code> and <code>naturalHeight</code> properties
of the image are the dimensions of the image file itself. The
<code>width</code> and <code>height</code> properties of the image are
the dimensions of the image as it is rendered on the page. See <a
href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement/naturalWidth">MDN</a>
for more information.
</details>
<p>In an <code>&lt;img&gt;</code> tag, if you set the width or height of
an image, the image will be scaled. In this case, the <a
href="mereri.jpg">image file</a> we are dealing with is 2000 wide and
1500 pixels tall. So if I set the width of the image to 500 pixels, the
image will be scaled to 500 pixels wide and 375 pixels tall (the height
is scaled automatically in proportion to the change in width):</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">mereri.jpg</span> <span class="er">width</span><span class="ot">=</span><span class="st">500</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;border:1px solid&quot;</span> <span class="er">class</span><span class="ot">=</span><span class="st">show-image-size</span><span class="kw">&gt;</span></span></code></pre></div>
<p><img src=mereri.jpg width=500 style="border:1px solid" class=show-image-size></p>
<p>Note that something similar happens if I set the height of the image
to 500 pixels:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">mereri.jpg</span> <span class="er">height</span><span class="ot">=</span><span class="st">500</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;border:1px solid&quot;</span> <span class="er">class</span><span class="ot">=</span><span class="st">show-image-size</span><span class="kw">&gt;</span></span></code></pre></div>
<p><img src=mereri.jpg height=500 style="border:1px solid" class=show-image-size></p>
<p>As you can see from the inline borders, the <code>&lt;img&gt;</code>
tag adjusts its size so that the aspect ratio of the image is
maintained. In effect, the image is scaled. If we set both
<code>height</code> and <code>width</code> in different proportions, the
image will be distorted to fit the dimensions we have set:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">mereri.jpg</span> <span class="er">height</span><span class="ot">=</span><span class="st">200</span> <span class="er">width</span><span class="ot">=</span><span class="st">800</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;border:1px solid&quot;</span> <span class="er">class</span><span class="ot">=</span><span class="st">show-image-size</span><span class="kw">&gt;</span></span></code></pre></div>
<p><img src=mereri.jpg height=200 width=800 style="border:1px solid" class=show-image-size></p>
<p>There’s one more thing worth noting before we move onto images in
<code>svg</code>: panning. If you’re using a trackpad, you can pan
around the image by using two fingers. If you’re using a touchscreen
device, you can pan around the image by dragging with one finger. This
is very much <em>not</em> how <code>SVG</code>s work, as we’ll see
below.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;figure</span>  <span class="er">style</span><span class="ot">=</span><span class="st">&quot;max-width: none; border:4px double pink; height:150px; width: 300px; overflow:auto;&quot;</span> <span class="kw">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">mereri.jpg</span>  <span class="er">style</span><span class="ot">=</span><span class="st">&quot;max-width: none; border:1px solid&quot;</span> <span class="er">class</span><span class="ot">=</span><span class="st">show-image-size</span><span class="kw">&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/figure&gt;</span></span></code></pre></div>
<figure style="max-width: none; border:4px double pink;height:150px; width: 300px; overflow:auto;">
<img src=mereri.jpg  style="max-width: none; border:1px solid" class=show-image-size>
</figure>
<p>So much for scaling <code>&lt;img&gt;</code> tags. In our web
component, we’ve decided to use an <code>&lt;svg&gt;</code>, and so the
our image will go into the <code>SVG</code>-land tag called <a
href="https://developer.mozilla.org/en-US/docs/Web/SVG/Element/image"><code>&lt;image&gt;</code></a>,
not <code>&lt;img&gt;</code>. The name isn’t the only thing that
changes: the whole system of scaling changes as well.</p>
<h2 id="scaling-svgs">Scaling <code>SVG</code>s</h2>
<p>The <code>&lt;image&gt;</code> tag in SVG is quite different from the
<code>&lt;img&gt;</code> tag in HTML. Most obviously, the
<code>&lt;img&gt;</code> tag is self-closing, but
<code>&lt;image&gt;</code> must be <code>&lt;/image&gt;</code>
closed.</p>
<p><code>&lt;image&gt;</code> also accepts different attributes than the
<code>&lt;img&gt;</code> tag. For one, the <code>href</code> attribute
on <code>&lt;image&gt;</code> replaces the <code>src</code> attribute of
an <code>&lt;img&gt;</code> tag, although it does the same thing — it
specifies the URL of the image file we want to show.</p>
<details>
<summary>
Why <code>src</code> in <code>&lt;img&gt;</code> but <code>href</code>
in <code>&lt;image&gt;</code>?
</summary>
<p>I was curious. Here’s what ChatGPT said.</p>
<blockquote>
<p>The difference between the <code>href</code> attribute for
<code>&lt;image&gt;</code> and the <code>src</code> attribute for
<code>&lt;img&gt;</code> comes down to the historical definitions and
usage of these elements.</p>
<ol type="1">
<li><p><strong><code>&lt;img&gt;</code> Element</strong>: The
<code>&lt;img&gt;</code> element is used to embed images in HTML
documents. The <code>src</code> attribute (short for “source”) defines
the source URL of the embedded image. This has been the standard way to
link to images in HTML for many years.</p></li>
<li><p><strong><code>&lt;image&gt;</code> Element</strong>: The
<code>&lt;image&gt;</code> tag is often associated with SVG (Scalable
Vector Graphics). In SVG, the <code>href</code> attribute is used to
link to an image source, aligning with the way links are defined in
other parts of the SVG specification.</p></li>
</ol>
<p>The divergence in attribute names may seem confusing, but it’s the
result of different standards and specifications that have evolved over
time. While HTML has its origins in defining static documents, SVG is an
XML-based vector image format that has its own specific ways of handling
links and references.</p>
<p>In modern browsers, you might find that the
<code>&lt;image&gt;</code> element in SVG will also accept the
<code>xlink:href</code> attribute, though this has been deprecated in
favor of simply using <code>href</code>.</p>
</blockquote>
</details>
<p>But the <em>way</em> that the file is shown varies drastically.
Below, I have the same image inserted into an <code>&lt;img&gt;</code>
tag above, but this time it’s inside an <code>&lt;image&gt;</code> tag
which is in turn inside an <code>&lt;svg&gt;</code> tag.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">svg</span><span class="ot"> class=</span><span class="st">&quot;show-svg-size&quot;</span><span class="ot"> style=</span><span class="st">&quot;border:3px double rebeccapurple&quot;</span> &gt;</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">image</span><span class="ot"> style=</span><span class="st">&quot;border:1px solid&quot;</span><span class="ot">  id=</span><span class="st">&quot;svg-image&quot;</span><span class="ot"> x=</span><span class="st">&quot;0&quot;</span><span class="ot"> y=</span><span class="st">&quot;0&quot;</span><span class="ot"> href=</span><span class="st">&quot;mereri.jpg&quot;</span>&gt;&lt;/<span class="kw">image</span>&gt;</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">svg</span>&gt;</span></code></pre></div>
<svg class="show-svg-size" style="border:3px double rebeccapurple" >
<image style="border:1px solid"  id="svg-image" x="0" y="0" href="mereri.jpg"></image>
</svg>
<p>Okay, weird. Some differences from the preceding
<code>&lt;img&gt;</code> tag:</p>
<ul>
<li>You <em>can’t</em> pan this image. If you try to, you’ll scroll the
whole page. It’s as if the browser didn’t notice that you were
interacting with the image.</li>
<li>This <code>&lt;svg&gt;</code> has the same dimensions as the
<code>&lt;img&gt;</code> tag above, and the image appears to be scaled
in exactly the same way (i.e. its <code>naturalWidth</code> and
<code>naturalHeight</code> are the being used to determine the size of
the image).</li>
<li>But note that I didn’t specify anywhere that the
<code>&lt;svg&gt;</code> should have the same dimensions as the
<code>&lt;img&gt;</code> tag: those are the default dimensions of the
<code>&lt;svg&gt;</code> tag. Rather, I specified that the
<code>&lt;img&gt;</code> should be like the
<code>&lt;svg&gt;</code>.</li>
</ul>
<p>Otherwise, the two approaches are giving us the same result: they are
cropping the original image in the same way, and they are not scaling
the image in any way.</p>
<p>An <code>&lt;svg&gt;</code> tag is really more like a window than a
container. It has a size, but it doesn’t have a size in the same way
that a <code>&lt;div&gt;</code> has a size. <code>&lt;div&gt;</code>s
get their sizes from their contents, or they can be explicitly set via
<code>CSS</code>. The size of an <code>&lt;svg&gt;</code> can also be
set via <code>CSS</code>, or by explicit <code>width</code> and
<code>height</code> attributes on the element itself. If use neither of
those options, the <code>&lt;svg&gt;</code> will have a default size of
<code>300px</code> by <code>150px</code>, which is what we’re seeing
here. (The <code>3px</code> purple border explains the 6 extra pixels on
both axes).</p>
<p>Note that there is no <code>naturalWidth</code> or
<code>naturalHeight</code> involved.</p>
<p>This is where <code>svg</code> scaling gets kind of complex.</p>
<h3 id="making-the-svg-assume-its-entire-space-in-our-interface.">Making
the <code>&lt;svg&gt;</code> assume its entire space in our
interface.</h3>
<p>Hey, remember how we were making an image annotation interface?</p>
<blockquote>
<p><em>I think one of the reasons discussions of <code>SVG</code>
scaling get confusing is that they are often described in isolation. I’m
hoping that this explanation will be more useful precisely
<strong>because</strong> we’re talking about a specific content — the
grid-based basic UI we described above.</em></p>
</blockquote>
<p>Let’s put this <code>SVG</code> back into the interface we were
working on above:</p>
<p><a href="display-image.html">display-image.html</a></p>
<iframe src="display-image.html" width="100%" height="500px">
</iframe>
<p>Now our <code>&lt;svg&gt;</code> tag finds itself inside the
<code>grid</code> layout we started working on (it’s found in <a
href="layout.css">layout.css</a>). But here I’ve updated the layout to
1) tell the <code>&lt;main&gt;</code> tag in our our UI that it should
be a <code>grid</code> container, and 2) tell the
<code>&lt;svg&gt;</code> tag to fill up the grid cell in which it finds
itself. Crucially, note that we are <em>not</em> using any specific
dimensions for anything. Here is the relevant <code>CSS</code>:</p>
<p><a href="display-image.css">display-image.css</a></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>main {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">display</span>: <span class="dv">grid</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>main svg {</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">height</span>: <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">width</span>: <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background-color</span>: <span class="cn">lightgray</span><span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If you open the the current step (<a
href="display-image.html">display-image.html</a>) in its own tab, you’ll
see much more of the <code>&lt;image&gt;</code> tag, but in all
likelihood it will still be cropped.</p>
<h3 id="setting-width-and-height">Setting <code>width</code> and
<code>height</code></h3>
<p><a href="width-and-height.html">width-and-height.html</a></p>
<iframe src="width-and-height.html" width="100%" height="500px">
</iframe>
<p><a href="width-and-height.css">width-and-height.css</a></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode css"><code class="sourceCode css"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>main {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">display</span>: <span class="dv">grid</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>main svg {</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">height</span>: <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">width</span>: <span class="dv">100</span><span class="dt">%</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">background-color</span>: <span class="cn">lightgray</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<p>I’m going to be honest with you, I can’t believe that this seems to
work as well as it does. I was gearing up to expect to have to use
<code>viewBox</code> and <code>naturalWidth</code> and
<code>naturalHeight</code> and a lot of matrix math and stuff. We’ll see
if this approach remains viable as we move into getting mouse
coordinates.</p>
</blockquote>
<p>Note what is happening here: if you resize your browser window,
you’ll see that image is scaled to keep it within the available area,
but it is not cropped. This pattern is referred to as <a
href="https://en.wikipedia.org/wiki/Letterboxing_(filming)">letterboxing</a>,
when a widescreen-formatted film is displayed on a standard television
screen with its original aspect ratio. “Mattes” are added above and
below to make the whole image fit.</p>
<p><img src=vertical-mattes.png></p>
<p>The same thing can happen if we make the browser window narrower,
except that the mattes will be on the sides:</p>
<p><img src=horizontal-mattes.png></p>
<h2 id="handling-mouse-clicks">Handling mouse clicks</h2>
<p>So, our image is scaling acceptably. (Yes, we’re going to want to
handle <a
href="https://css-tricks.com/creating-a-panning-effect-for-svg/">panning</a>
and zooming. We’ll get to that later.) Now we need to deal with mouse
coordinates.</p>
<h3 id="where-was-that-click">Where was that click?</h3>
<p>In a click event listener, we get an object that describes the click
event in the callback function as the second argument of
<code>.addEventListener</code>. This object is called a
<code>MouseEvent</code>. It has a property called <code>clientX</code>
that gives the x-coordinate of the click event, and a property called
<code>clientY</code> that gives the y-coordinate of the click event.
<code>clientX</code> and <code>clientY</code> are relative to something
called the <em>viewport</em>, which is essentially the browser window.
So if you click in the upper left corner of the browser window, you’ll
get <code>clientX</code> and <code>clientY</code> values close to 0.</p>
<p>In the demo below, we have an empty page where you can try this. Note
that the origin is in the upper left corner: if you click up there
you’ll get <code>clientX</code> and <code>clientY</code> values close to
0. (There is actually an information <code>&lt;div&gt;</code> placed in
the top right corner, but it has a <code>CSS</code> property called
<code>pointer-events</code> set to <code>none</code>, which means it is
ignored when you happen to click inside it. The full <code>CSS</code> is
<a href="you-clicked-at.css">here</a>.)</p>
<p><a href="you-clicked-at.html">you-clicked-at.html</a></p>
<iframe src="you-clicked-at.html" width="100%" height="500px">
</iframe>
<p>Note that the listener here is listening to the
<code>&lt;body&gt;</code> tag, which is the full viewport. (We removed
the default <code>8px</code> margin from the <code>&lt;body&gt;</code>
and <code>&lt;html&gt;</code> elements to keep things simple.) It looks
like this:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="at">body</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&#39;click&#39;</span><span class="op">,</span> clickEvent <span class="kw">=&gt;</span> {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;td.x&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>clickEvent<span class="op">.</span><span class="at">clientX</span><span class="sc">}</span><span class="vs">px`</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="fu">querySelector</span>(<span class="st">&#39;td.y&#39;</span>)<span class="op">.</span><span class="at">textContent</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>clickEvent<span class="op">.</span><span class="at">clientY</span><span class="sc">}</span><span class="vs">px`</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/script&gt;</span></span></code></pre></div>
<p>Also, if your head is spinning, remember that the demo above is
inside of an <code>&lt;iframe&gt;</code> tag! So there really is a whole
document inside that demo box — try opening it in a new tab for a more
“pure” experience of the viewport vis-à-vis your browser window.</p>
<p>But sometimes, we want to know where we clicked relative to the
boundaries of a particular element, rather than relative to the whole
viewport (the <code>&lt;body&gt;</code> tag). For those cases there is
another pair of event properties to look at: <code>offsetY</code> and
<code>offsetX</code>. These properties are relative to the element that
is listening for the event. So if we listen for a click event on the
<code>&lt;body&gt;</code> tag, the <code>offsetX</code> and
<code>offsetY</code> values will be relative to the
<code>&lt;body&gt;</code> tag. If we listen for a click event on a
<code>&lt;div&gt;</code> tag, the <code>offsetX</code> and
<code>offsetY</code> values will be relative to the boundaries of that
<code>&lt;div&gt;</code> tag. Try it out below:</p>
<p><a href="you-clicked-at-2.html">you-clicked-at-2.html</a></p>
<iframe src="you-clicked-at-2.html" width="100%" height="500px">
</iframe>
<p>As you can see, the <code>&lt;body&gt;</code> column only updates
when you click outside of the yellow box. Otherwise, the
<code>&lt;div&gt;</code> column updates because the
<code>&lt;div&gt;</code> intercepts the click event first.</p>
<p>And take note: the <code>offsetX</code> and <code>clientX</code>
values are <em>different</em> in the <code>&lt;div&gt;</code> column,
because <code>offsetX</code> has its own coordinate system with
<code>0,0</code> in its top left corner, but they are the <em>same</em>
in the <code>&lt;body&gt;</code> column.</p>
<p>So when we make a selection on our <code>&lt;image&gt;</code>, the
<code>offsetX</code> and <code>offsetY</code> will be more important
than the <code>clientX</code> and <code>clientY</code> values, since we
want to know where in the <em>image</em> we are clicking, not where in
the <em>document</em> we are clicking. So, let’s test out our previous
layout with the <code>&lt;svg&gt;</code> and see what happens:</p>
<p><a href="click-image.html">click-image.html</a></p>
<iframe src="click-image.html" width="100%" height="500px">
</iframe>
<p>So, I’ve added the click location debugging code into this
application too. If you click in lower right corner of the Mereri image,
while the <code>offsetX</code> values vary for
<code>&lt;body&gt;</code>, <code>&lt;svg&gt;</code>, and
<code>&lt;image&gt;</code>, we do not see values that suggest the full
width of the 2000px by 1500px image. So although the image has been
scaled to fit as per the previous section, the <code>offsetX</code> and
<code>offsetY</code> values are not scaled. We will have to figure out
how to do that ourselves.</p>
<script type=module src=index.js></script>
</body>
</html>
